---
title: "JMCNA 2021 - Data collection"
runtime : shiny
output: 
  flexdashboard::flex_dashboard:
    # theme: cerulean
    orientation: rows
    vertical_layout: scroll
    social : ["twitter","linkedin", "menu"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)
library(flexdashboard)
library(lubridate)
library(shiny)
library(leaflet)
library(leaflet.extras)
library(readxl)
library(httr)
# library(dygraphs)
# library(xts)
# library(scales)
library(plotly)
library(DT)
# library(tmaptools)
# library(tmap)
# library(sf)
library(tidyverse)
# library(writexl)
# library(knitr)
# library(RColorBrewer)
# library(viridisLite)


```


```{r setup kobo connection, warning=FALSE, include=FALSE}


source("Functions.R")
url <-"https://kc.humanitarianresponse.info/api/v1/data.csv" ## Do not change this 
kobo_user <-  "reachsomalia" ## kobo user 
kobo_pw <- "ReachSom2020" ## kobo password 
d_formlist_csv <- as.data.frame(kobohr_getforms_csv (url,kobo_user, kobo_pw)) ## Run this to get the list of deployed tool 
form_id <-  "140646" ## Check the d_formlist_csv dataframe to get the correct form id
dataurl<- paste0("https://kc.humanitarianresponse.info/api/v1/data/",form_id,".csv") ## Do not change this 

df <- download_data(dataurl,kobo_user,kobo_pw)
colnames(df) <- gsub('^(?:[^/]*/)*(.*)', '\\1', colnames(df)) ## Removing group names from header

```

```{r Loading sampling files, message=FALSE, warning=FALSE, include=FALSE}

## data_all and data are test datasets, use the dataframe downloaded from the server (df).
## Make sure that the columns name are the same, if not I suggest that you change the naming in the dataset and keep
## the code as it is. An easy way around this is to use the rename function:
##################################################X
# df %>% 
#  rename(
#    new_name = old_name,
#    new_name2 = old_name2
#    )
##################################################X

data_all <- read.csv("input/rawdata.csv",stringsAsFactors = F) 
data <- head(data_all,9500)
target_region <- read.csv("input/target_region.csv",stringsAsFactors = F)
target_district <- read.csv("input/target_district.csv",stringsAsFactors = F)

```

Main
=====================================

Row
-----------------------------------------------------------------------

### Conducted surveys
```{r}
valueBox(length(data$X_uuid),
         icon = "fa-file-text")
```

### National target

```{r}
rate <- computeSurveyRate(data,sum(target_district$target))
gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)
))
```


### district covered
```{r}
valueBox(length(unique(data$district)),
         icon = "fa-globe")
```


### Average survey duration
```{r}

valueBox(paste(computeDurationAverage(data)," Minutes"),
         icon = "fa-clock-o")
```



Row {data-heigth=650}
-----------------------------------------------------------------------


### Surveys submission overview - ALL

```{r}

p1 <- data %>% 
  group_by(region) %>% 
  summarise(count = n()) %>% 
  left_join(target_region %>% 
  select(region, total = target)) %>% 
  plot_ly( x = ~region,
           y = ~count,
           # color='blue',
           # text=c('A','B','C','D','B','C','D','A','A'),
           # textposition = 'auto',
           type='bar',
           name= "Conducted surveys"
           ) %>%
  add_trace(y = ~total, name = 'Remaining surveys') %>%
  layout(xaxis= list(title="Region"),
         yaxis= list(title="Surveys count"),
         barmode = 'stack')
p1
```

Row {data-heigth=650}
-----------------------------------------------------------------------


### Surveys submission overview - IDP

```{r}

p1 <- data %>% filter(idp_settlement == "yes") %>%
  group_by(region) %>% 
  summarise(count = n()) %>% 
  left_join(target_region %>% 
  select(region, total = idp)) %>% 
  plot_ly( x = ~region,
           y = ~count,
           # color='blue',
           # text=c('A','B','C','D','B','C','D','A','A'),
           # textposition = 'auto',
           type='bar',
           name= "Conducted surveys"
           ) %>%
  add_trace(y = ~total, name = 'Remaining surveys') %>%
  layout(xaxis= list(title="Region"),
         yaxis= list(title="Surveys count"),
         barmode = 'stack')
p1
```

### Surveys submission overview - Non IDP

```{r}

p1 <- data %>% filter(idp_settlement == "no")  %>%
  group_by(region) %>% 
  summarise(count = n()) %>% 
  left_join(target_region %>% 
  select(region, total = non_idp)) %>% 
  plot_ly( x = ~region,
           y = ~count,
           # color='blue',
           # text=c('A','B','C','D','B','C','D','A','A'),
           # textposition = 'auto',
           type='bar',
           name= "Conducted surveys"
           ) %>%
  add_trace(y = ~total, name = 'Remaining surveys') %>%
  layout(xaxis= list(title="Region"),
         yaxis= list(title="Surveys count"),
         barmode = 'stack')
p1
```

All {data-navmenu="Regions"}
=====================================

### Surveys submission overview - Partner

```{r}

  datatable(
    data=data %>% group_by(region) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_region %>% 
    select(region, Target = target)) %>% 
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
 
  


```

IDP {data-navmenu="Regions"}
=====================================

### Surveys submission overview - Partner

```{r}

  datatable(
 
    data=data %>% filter(idp_settlement == "yes") %>% group_by(region) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_region %>% 
    select(region, Target = idp)) %>% 
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
 
  


```


Non IDP {data-navmenu="Regions"}
=====================================

### Surveys submission overview - Partner

```{r}

  datatable(
    data=data %>% filter(idp_settlement == "no") %>% group_by(region) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_region %>% 
    select(region, Target = non_idp)) %>%  
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
 
  


```

All {data-navmenu="Districts"}
=====================================

Column {.sidebar}
-------------------------------------
```{r}
selectInput("RegionFilterA",
            "Regions:",
            choices = c("All",unique(data$region)))

```



Column {}
-------------------------------------
```{r}


DT::renderDataTable({
        if(input$RegionFilterA != "All"){
          datatable(
    data= data %>% filter(region == input$RegionFilterA )%>% group_by(district) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_district %>% 
    select(district = District_xml, Target = target)) %>%  
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
        }
        else if(input$RegionFilterA == "All"){
          datatable(
    data= data %>% group_by(district) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_district %>% 
    select(district = District_xml, Target = target)) %>%  
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
        }   
    }) 

  
  
```

IDP {data-navmenu="Districts"}
=====================================

Column {.sidebar}
-------------------------------------
```{r}
selectInput("RegionFilterB",
            "Regions:",
            choices = c("All",unique(data$region)))

```



Column {}
-------------------------------------
```{r}


DT::renderDataTable({
        if(input$RegionFilterB != "All"){
          datatable(
    data= data %>% filter(idp_settlement == "yes") %>% filter(region == input$RegionFilterB )%>% group_by(district) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_district %>% 
    select(district = District_xml, Target = target)) %>%  
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
        }
        else if(input$RegionFilterB == "All"){
          datatable(
    data= data %>%  filter(idp_settlement == "yes") %>%  group_by(district) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_district %>% 
    select(district = District_xml, Target = target)) %>%  
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
        }   
    }) 

  
  
```

Non IDP {data-navmenu="Districts"}
=====================================

Column {.sidebar}
-------------------------------------
```{r}
selectInput("RegionFilterC",
            "Regions:",
            choices = c("All",unique(data$region)))

```



Column {}
-------------------------------------
```{r}


DT::renderDataTable({
        if(input$RegionFilterC != "All"){
          datatable(
    data= data %>% filter(idp_settlement == "no") %>% filter(region == input$RegionFilterC )%>% group_by(district) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_district %>% 
    select(district = District_xml, Target = target)) %>%  
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
        }
        else if(input$RegionFilterC == "All"){
          datatable(
    data= data %>%  filter(idp_settlement == "no") %>% group_by(district) %>% 
    summarise(Submission = n()) %>% 
    left_join(target_district %>% 
    select(district = District_xml, Target = target)) %>%  
    mutate( Remaining = Target - Submission, 
           `Completion (%)` = round(Submission/Target * 100 , digits = 2)  ) ,
    filter = "top",
    options = list(pageLength=25),
    rownames = F
  
) %>%
      formatStyle("Completion (%)", backgroundColor = styleInterval(
      c(25,50,75), 
      c("red","orange","yellow","lightgreen")))
        }   
    }) 

  
  
```

<!--
Maps {}
=====================================

Column {data-height = 200}
-------------------------------------------------

### Map 

```{r, fig.height=9, fig.width=20}

df2 <- read.csv("input/gps.csv",stringsAsFactors = F)
df2 %>% mutate(
  map_label = paste(region, "_", district, "_", settlement),
          circle_uuid = X_uuid ) %>%  
  leaflet() %>% addTiles() %>% 
  addCircleMarkers(lng= ~X_observation_gps_longitude,
                   lat= ~X_observation_gps_latitude,
                   clusterOptions = markerClusterOptions(),
                   popup = ~ map_label,
                   label = ~ map_label,
                   group = 'circle_uuid',
                   
                   ) %>%
  addResetMapButton() %>%
  
  addSearchFeatures(
    targetGroups = 'district',
    options = searchFeaturesOptions(
      zoom=12, openPopup = TRUE, firstTipSubmit = TRUE,
      autoCollapse = FALSE, hideMarkerOnCollapse = TRUE )
  ) %>%
  
  addMiniMap(toggleDisplay = TRUE) %>%
  addTiles() %>% 
  addMeasure(position = "bottomleft", 
             primaryLengthUnit = "meters",
             primaryAreaUnit = "sqmeters",
             activeColor = "#3D535D",
             completedColor = "#7D4479")
 
  



```

-->

